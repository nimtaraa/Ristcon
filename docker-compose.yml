version: '3.8'

services:
  # ===========================================
  # Database Service - MariaDB
  # ===========================================
  db:
    image: mariadb:10.11
    container_name: ristcon-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./ristcon-backend/database/RistconDb.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "${DB_PORT:-3306}:3306"
    networks:
      - ristcon-network
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # Laravel Backend Service
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    container_name: ristcon-backend
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME:-RISTCON}
      APP_ENV: ${APP_ENV:-production}
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_URL: ${APP_URL:-http://localhost:8080}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      ADMIN_URL: ${ADMIN_URL:-http://localhost:3001}
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SESSION_DRIVER: ${SESSION_DRIVER:-database}
      CACHE_STORE: ${CACHE_STORE:-database}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-database}
    volumes:
      - backend_storage:/var/www/html/storage
    ports:
      - "${BACKEND_PORT:-8080}:80"
    networks:
      - ristcon-network
    depends_on:
      db:
        condition: service_healthy

  # ===========================================
  # Public Frontend Service (React)
  # ===========================================
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8080/api/v1}
    container_name: ristcon-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    networks:
      - ristcon-network
    depends_on:
      - backend

  # ===========================================
  # Admin Frontend Service (React)
  # ===========================================
  admin:
    build:
      context: .
      dockerfile: docker/admin/Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8080/api/v1}
        VITE_FRONTEND_URL: ${VITE_FRONTEND_URL:-http://localhost:3000}
    container_name: ristcon-admin
    restart: unless-stopped
    ports:
      - "${ADMIN_PORT:-3001}:80"
    networks:
      - ristcon-network
    depends_on:
      - backend

# ===========================================
# Networks
# ===========================================
networks:
  ristcon-network:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  db_data:
    driver: local
  backend_storage:
    driver: local
